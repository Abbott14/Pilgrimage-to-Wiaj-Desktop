<!DOCTYPE html>
<html>
<head>
  <title>The New Pilgrimage to Wiaj</title>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

  <style>
    html, body {
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
      background: #000000;
      overflow: hidden;
    }

    #openfl-content {
      background: #000000;
      width: 100%;
      height: 100%;
    }

    @font-face {
      font-family: 'D-DIN';
      font-weight: normal;
      font-style: normal;
    }

    @font-face {
      font-family: 'Whitney-Book';
      font-weight: 500;
      font-style: normal;
    }

    #game {
      width: 100%;
      height: 100%;
      display: flex;
      justify-content: center;
      align-items: center;
      background: #000000;
    }

    #builder {
      outline: none;
      margin: 0;
      /* Size will be set dynamically by JavaScript */
    }
  </style>
</head>
<body>
  <div id="game">
    <div id="builder" oncontextmenu="return false;"></div>
  </div>

  <!-- Load dependencies from local files -->
  <script src="../scripts/jquery-1.8.3.min.js"></script>
  <script src="../../node_modules/howler/dist/howler.min.js"></script>
  <script src="../scripts/pubnub.4.21.2.js"></script>
  <script src="../scripts/rtc-pubnub.js"></script>
  <script src="../scripts/rtc-xirsys.js"></script>
  <script src="../scripts/flowAudio.js"></script>
  <script src="../scripts/flowlab-engine-5000.js"></script>

  <!-- Set base URL after local scripts load so game API calls resolve to flowlab.io -->
  <script type="text/javascript">
    // Add base tag to make relative URLs point to flowlab.io
    var base = document.createElement('base');
    base.href = 'https://flowlab.io/';
    document.head.insertBefore(base, document.head.firstChild);
    console.log("Base URL set to:", base.href);
  </script>

  <script type="text/javascript">
    // Prevent touch scrolling
    window.addEventListener("touchmove", function (event) {
      event.preventDefault();
    }, { capture: false, passive: false });

    // Adjust viewport for high DPI displays
    if (typeof window.devicePixelRatio != 'undefined' && window.devicePixelRatio > 2) {
      var meta = document.getElementById("viewport");
      if (meta) {
        meta.setAttribute('content', 'width=device-width, initial-scale=' + (2 / window.devicePixelRatio) + ', user-scalable=no');
      }
    }

    // Don't leave page on backspace
    window.addEventListener('keydown', function(e) {
      if (e.keyIdentifier == 'U+0008' || e.keyIdentifier == 'Backspace' || e.keyCode == 8) {
        if (e.target == document.body) {
          e.preventDefault();
          return false;
        }
      }
    }, true);

    // Initialize FlowAudio
    var flowAudio = new FlowAudio();
    var page_theme = {};
    var favorited = false;
    var gameEl;
    var cursorHidden = false;
    var cursorValidateTimer;

    // Handle menu actions from main process
    const { ipcRenderer } = require('electron');

    // Listen for mute toggle from menu
    ipcRenderer.on('toggle-mute', (event, isMuted) => {
      console.log('Mute toggled:', isMuted);
      if (isMuted) {
        flowAudio.pauseAll();
      } else {
        flowAudio.resumeAll();
      }
    });

    // Page setup
    const pageSetup = function() {
      gameEl = document.getElementById('builder');
    }

    if (document.readyState !== 'loading') {
      pageSetup();
    } else {
      document.addEventListener('DOMContentLoaded', pageSetup);
    }

    // Haxe mockups for dealing with cross-compiled expressions
    var Std = {
      string: function(str) { return str + ""; }
    }

    class HxOverrides {
      static substr(s, pos, len) {
        if (len == null) {
          len = s.length;
        } else if (len < 0) {
          if (pos == 0) {
            len = s.length + len;
          } else {
            return "";
          }
        }
        return s.substr(pos, len);
      }

      static now() {
        return Date.now();
      }
    }

    // Cursor toggle functions
    function toggleCursor(showMouse) {
      if (showMouse) {
        console.log("[+] show mouse cursor");
        cursorHidden = false;
        validateCursorState();
        removeCursorValidation();
        if (document.getElementById("builder")) {
          document.getElementById("builder").style.cursor = 'auto';
        }
      } else {
        console.log("[-] hide mouse cursor");
        cursorHidden = true;
        validateCursorState();
        addCursorValidation();
      }
    }

    function addCursorValidation() {
      if (gameEl) {
        gameEl.addEventListener("mousedown", validateCursorState);
        gameEl.addEventListener("mouseover", validateCursorState);
        console.log("cursor validation: on");
        cursorValidateTimer = setTimeout(validateCursorState, 1000);
      }
    }

    function removeCursorValidation() {
      if (gameEl) {
        gameEl.removeEventListener("mousedown", validateCursorState);
        gameEl.removeEventListener("mouseover", validateCursorState);
        console.log("cursor validation: off");
        if (cursorValidateTimer) {
          clearTimeout(cursorValidateTimer);
        }
      }
    }

    function validateCursorState() {
      var b = document.getElementById('builder');
      if (b && cursorHidden && b.style.cursor != 'none') {
        b.style.cursor = 'none';
      }
    }

    // Initialize RTC for multiplayer
    var rtcPubNub = new RtcPubNub();
    var rtcXirsys = new RtcXirsys();

    // Initialize the game with full absolute URLs to flowlab.io
    lime.embed("Flowlab", "builder", 0, 0, {
      rootPath: "https://flowlab.io/html5/bin",
      parameters: {
        auth_token: "",
        game: "2687779",
        asset_root: 'assets2',
        splash: "",
        splash_bg: null,
        splash_bar: null,
        splash_logo: false,
        splash_logo_x: null,
        splash_logo_y: null,
        uid: "",
        mode: "embed",
        chrome: !!window.chrome,
        membership: "",
        send_events: false,
        viewW: "384.0",
        viewH: "384.0"
      }
    });

    // Prevent space and arrow keys from scrolling
    window.addEventListener('keydown', function(e) {
      if ((e.keyCode == 32 || e.keyCode == 38 || e.keyCode == 40) && e.target == document.body) {
        e.preventDefault();
      }
    });

    // Stub out connection status
    function displayConnectionStatus(msg, state) {
      console.log("connection status: " + msg + "/" + state);
    }

    // Dynamic canvas resizing to fill window while maintaining aspect ratio
    var gameTargetWidth = 384;
    var gameTargetHeight = 384;
    var gameAspectRatio = 1.0; // 384/384

    function resizeCanvas() {
      var gameEl = document.getElementById('builder');
      if (!gameEl) return;

      // Get the actual canvas element (OpenFL creates it)
      var canvas = gameEl.querySelector('canvas');
      if (!canvas) {
        // Try again in 100ms if canvas isn't ready yet
        setTimeout(resizeCanvas, 100);
        return;
      }

      // Get window dimensions
      var windowWidth = window.innerWidth;
      var windowHeight = window.innerHeight;

      // Calculate scaled dimensions that fit window while maintaining aspect ratio
      var scale = Math.min(
        windowWidth / gameTargetWidth,
        windowHeight / gameTargetHeight
      );

      var newWidth = Math.floor(gameTargetWidth * scale);
      var newHeight = Math.floor(gameTargetHeight * scale);

      // Set the game element size
      gameEl.style.width = newWidth + 'px';
      gameEl.style.height = newHeight + 'px';

      // Also set canvas size for crisp rendering
      if (canvas) {
        canvas.style.width = newWidth + 'px';
        canvas.style.height = newHeight + 'px';
      }

      console.log("Canvas resized to: " + newWidth + "x" + newHeight + " (scale: " + scale.toFixed(2) + ")");
    }

    // Resize on window resize
    window.addEventListener('resize', resizeCanvas);

    // Initial resize after a short delay to let the game initialize
    setTimeout(function() {
      resizeCanvas();
      // Keep trying for a few seconds in case the canvas takes time to create
      var retries = 0;
      var resizeInterval = setInterval(function() {
        resizeCanvas();
        retries++;
        if (retries > 20) clearInterval(resizeInterval);
      }, 200);
    }, 500);

    // Log when game is ready
    console.log("Pilgrimage to Wiaj - Desktop Edition");
    console.log("Game initializing...");
    console.log("Note: Game assets load from flowlab.io (requires internet connection)");
    console.log("Window will auto-resize to fill screen while maintaining aspect ratio");
  </script>
</body>
</html>
